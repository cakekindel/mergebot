name: 'deploy'

on:
  push:
    branches: [ 'main' ]

jobs:
  deploy:
    runs-on: 'ubuntu-latest'
    steps:
    - uses: 'actions/checkout@v2'

    - uses: actions/cache@v2
      with:
        path: |
          ~/.rustup
          ~/.cargo
          target
        key: ${{ runner.os }}-cargo

    - uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.KEY }}
        script: |
          # Print reboot logs
          journalctl --since "$(date --iso-8601 --utc)" \
                     --no-pager \
                     --follow \
                     --unit mergebot \
          & systemctl restart mergebot;
          kill %1;
